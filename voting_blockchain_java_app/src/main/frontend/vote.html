<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Submit Vote</title>
    <style>
        ul {
            height: 5vh;
            width: 100%;
            background-color: lightgray;

            list-style-type: none;
            margin: 0;
            padding: 0;


            display: flex;
            justify-content: space-evenly;
            align-items: center;

        }

        li {
        }
    </style>
</head>
<body>
<header>
    <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="register.html">Register</a></li>
        <li><a href="vote.html">Vote</a></li>
        <li><a href="about.html">About</a></li>
    </ul>
</header>
<h1>Submit Your Vote</h1><br>
<hr style="border: none; height: 5px; background-color: black; width: 100%;">
<form id="voteForm">

    <label for="voterId">Voter ID:</label>
    <input type="text" id="voterId" name="voterId" required><br>

    <hr style="border: none; height: 2px; background-color: black; width: 100%;">


    <p>Candidate: </p>

    <input type="radio" id="reform" name="voteValue" value=1 required>
    <label for="reform">Reform</label><br>

    <input type="radio" id="conservatives" name="voteValue" value=2>
    <label for="conservatives">Conservatives</label><br>

    <input type="radio" id="labour" name="voteValue" value=3>
    <label for="conservatives">Labour</label><br>

    <input type="radio" id="libdems" name="voteValue" value=4>
    <label for="conservatives">Liberal Democrats</label><br>

    <hr style="border: none; height: 2px; background-color: black; width: 100%;">

    <label for="sign">Sign: </label>
    <input type="text" id="sign" name="privateKey"required><br>

    <hr style="border: none; height: 5px; background-color: black; width: 100%;">

    <button type="submit">Submit Vote</button>
</form>

<p id="response"></p>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('voteForm');

        form.addEventListener('submit', async (event) => {
            event.preventDefault();


            const voterId = document.getElementById('voterId').value.trim(); // Public Key
            const voteValue = document.querySelector('input[name="voteValue"]:checked').value; // Vote Value
            const privateKeyString = document.getElementById('sign').value.trim(); // Private Key

            if (!(voterId && voteValue && privateKeyString)) {
                document.getElementById("response").innerText = "Please fill in all fields.";
                return;
            }

            const content = `${voterId}|||${voteValue}`;

            console.log("Private key string length:", privateKeyString.length);
            console.log("First few characters:", privateKeyString.slice(0, 30));

            const privateKey = await stringToPrivateKey(privateKeyString);
            const signature = await signMessage(privateKey, content);

            if (signature == null) {
                document.getElementById("response").innerText = "Failed to sign vote"
                return;
            }

            const data = {
                voter: voterId,
                voteValue: voteValue,
                signature: signature,
            }

            try {
                const res = await fetch("/vote", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });

                document.getElementById("response").innerText = await res.text();
            } catch (err) {
                console.log(err);
                document.getElementById("response").innerText = "Failed to submit vote, please try again later"
            }


        })
    })

    async function stringToPrivateKey(privateKeyString) {
        try {
            const binary = atob(privateKeyString);
            const keyBytes = new Uint8Array([...binary].map(c => c.charCodeAt(0)));

            return await crypto.subtle.importKey(
                "pkcs8",
                keyBytes.buffer,
                {
                    name: "RSASSA-PKCS1-v1_5",
                    hash: "SHA-256"
                },
                false,
                ["sign"]
            );
        }catch(err){
            console.error("Invalid RSA private key", err);
            return null;
        }
    }

    async function signMessage(privateKey, message) {
        try{
            const encoder = new TextEncoder();
            const signature = await crypto.subtle.sign(
                "RSASSA-PKCS1-v1_5",
                privateKey,
                encoder.encode(message)
            );
            return btoa(String.fromCharCode(...new Uint8Array(signature)));
        } catch(err){
            console.error("RSA signing error", err);
            return null;
        }
    }
</script>

</body>
</html>